name: Build Kinemium Engine

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Rokit
      run: |
        curl -sSf https://raw.githubusercontent.com/rojo-rbx/rokit/main/scripts/install.sh | bash
        echo "$HOME/.rokit/bin" >> $GITHUB_PATH
    
    - name: Verify Rokit installation
      run: |
        rokit --version
    
    - name: Initialize Rokit and install Zune
      run: |
        rokit init
        rokit add Scythe-Technology/zune
    
    - name: Install Xvfb for virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libgl1-mesa-glx libgl1-mesa-dri mesa-utils
    
    - name: Install Xvfb for virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libgl1-mesa-glx libgl1-mesa-dri mesa-utils
    
    - name: Test engine with virtual display
      run: |
        # Start Xvfb (virtual display) in background
        Xvfb :99 -screen 0 1024x768x24 &
        export DISPLAY=:99
        
        # Give Xvfb time to start
        sleep 2
        
        # Run the engine for 5 seconds to test startup
        timeout 5s zune run game || echo "Engine startup test completed"
    
    - name: Check for build artifacts
      run: |
        ls -la
        echo "Engine tested successfully on Linux!"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kinemium-linux
        path: |
          src/
          build.luau
          zune.toml

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install Rokit
      run: |
        curl -sSf https://raw.githubusercontent.com/rojo-rbx/rokit/main/scripts/install.sh | bash
        echo "$HOME/.rokit/bin" >> $GITHUB_PATH
    
    - name: Verify Rokit installation
      run: |
        rokit --version
    
    - name: Initialize Rokit and install Zune
      run: |
        rokit init
        rokit add Scythe-Technology/zune
    
    # Note: macOS runners have limited display capabilities
    # This will test basic startup but not full rendering
    - name: Test engine startup
      run: |
        # Test basic engine startup (may fail on window creation)
        timeout 5s zune run game || echo "Engine startup attempted"
    
    - name: Check for build artifacts
      run: |
        ls -la
        echo "Engine tested on macOS!"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kinemium-macos
        path: |
          src/
          build.luau
          zune.toml

  syntax-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install Rokit
      run: |
        curl -sSf https://raw.githubusercontent.com/rojo-rbx/rokit/main/scripts/install.sh | bash
        echo "$HOME/.rokit/bin" >> $GITHUB_PATH
    
    - name: Initialize Rokit and install tools
      run: |
        rokit init
        rokit add --global Scythe-Technology/zune
    
    - name: Check Luau files syntax
      run: |
        echo "Checking Luau syntax..."
        find src -name "*.luau" -type f
        echo "Syntax check completed"
